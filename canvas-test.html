<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        canvas {
            cursor: pointer;
            border: 1px solid black;
        }
    </style>
</head>

<body>
    <canvas id="canvas" width="800" height="500">
    </canvas>
    <label for="selectFile">
        <input id="selectFile" name="selectFile" type="file" />
    </label>
    <label for="inputText">
        <input id="inputText" name="inputText" type="text" value="请输入文字" />
    </label>
    <input id="inputBtn" type="button" value="输入" />
    <div>
        <button id="clear-btn">清空画布</button>
    </div>
    <div id="tmp-div"></div>
    <script>

        // 储存每个文字对象
        var Text = function (content, fontSize, fontFamily, fillStyle, strokeStyle, lineWidth) {
            this.content = content;
            this.fontSize = fontSize;
            this.fontFamily = fontFamily;
            this.fillStyle = fillStyle;
            this.strokeStyle = strokeStyle;
            this.lineWidth = lineWidth;
            this.x = 200;
            this.y = 40;
            this.width;
            this.height;
            this.isSelected = false;
        }

        var Canvas = function (canvasId) {
            this.canvas = document.getElementById(canvasId);
            this.context = this.canvas.getContext("2d");
            // 保存画布上所有的圆圈
            this.circles = [];
            // 上一个被选中的圆圈
            this.previousSelectedCircle;
            // 文字拖拽状态
            this.isDragging = false;
            // 背景图片
            this.image;
            // 保存画布上的文字
            this.text;
        }

        Canvas.prototype.clearCanvas = function () {
            // 去除所有圆圈
            this.circles = [];

            // 重新绘制画布.
            this.drawCanvas();
        }

        Canvas.prototype.drawCanvas = function () {
            // 清除画布，准备绘制
            this.context.clearRect(0, 0, canvas.width, canvas.height);

            if (this.image != undefined) {
                this.context.drawImage(this.image, 0, 0, this.canvas.width, this.canvas.height);
            }
            var circles = this.circles;

            if (this.text != undefined) {
                var text = this.text;
                // 确定文本宽高
                var tmpDivElm = document.getElementById('tmp-div');
                tmpDivElm.style['font'] = text.fontSize + ' ' + text.fontFamily;
                // 使 line-height == fontsize
                tmpDivElm.style['line-height'] = text.fontSize;
                tmpDivElm.innerText = text.content;

                // 确定
                text.width = this.context.measureText(text.content).width;
                text.height = parseInt(text.fontSize);

                // 结束

                // 判断是否选中
                if (text.isSelected) {
                    this.context.strokeRect(text.x, text.y - text.height, text.width, text.height);
                }

                this.context.font = "36px" + " Impact"
                this.context.fillStyle = text.fillStyle;
                this.context.fillText(text.content, text.x, text.y);
                this.context.strokeStyle = text.strokeStyle;
                this.context.lineWidth = text.lineWidth;
                this.context.strokeText(text.content, text.x, text.y);
            }
        }

        Canvas.prototype.drawText = function (e) {
            var ctx = this.context;
            var text = new Text(inputElm.value, '36px', 'Impact', 'white', 'black', '1');
            this.text = text;

            // 更新画布
            this.drawCanvas();

            // x y的位置位于文字左下角的位置
            // ctx.strokeText('王治文', 100, 50);
        }

        Canvas.prototype.stopDragging = function (e) {
            this.isDragging = false;
        }

        Canvas.prototype.dragText = function (e) {
            var canvas = this.canvas;
            // 判断圆圈是否开始拖拽
            if (this.isDragging == true) {
                // // 判断拖拽对象是否存在
                // if (this.previousSelectedCircle != null) {
                    // 取得鼠标位置
                    var x = e.pageX - canvas.offsetLeft;
                    var y = e.pageY - canvas.offsetTop;

                    // 将文本移动到鼠标位置
                    // 限制鼠标 + 文本 不能 > 最大 x
                    if (x + this.text.width > this.canvas.width) {
                        this.text.x = this.canvas.width - this.text.width;
                    } else {
                        this.text.x = x;
                    }

                    // 限制鼠标 + 文本 不能 < 最小 y
                    if (y - this.text.height < 0 ) {
                        this.text.y = this.text.height;
                    } else {
                        this.text.y = y;
                    }

                    // 更新画布
                    this.drawCanvas();
                // }
            }
        }

        //在某个范围内生成随机数
        function randomFromTo(from, to) {
            return Math.floor(Math.random() * (to - from + 1) + from);
        }

        let circleCanvas = new Canvas("canvas");

        let addBtnElm = document.getElementById('add-btn');
        let clearBtnElm = document.getElementById('clear-btn');

        clearBtnElm.addEventListener('click', function () {
            circleCanvas.clearCanvas();
        })

        /* 绘图 */
        Canvas.prototype.redrawMeme = function (image, topLine, bottomLine) {
            this.image = image;
            var ctx = this.context;
            if (image != null)
                ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

            // // 文本属性
            // ctx.font = '30pt Impact';
            // ctx.textAlign = 'center';
            // ctx.strokeStyle = 'black';
            // ctx.lineWidth = 3;
            // ctx.fillStyle = 'white';

            // if (topLine != null) {
            //     ctx.fillText(topLine, canvas.width / 2, 0);
            //     ctx.strokeText(topLine, canvas.width / 2, 0);
            // }

            // if (bottomLine != null) {
            //     ctx.fillText(bottomLine, canvas.width / 2, canvas.height - 20);
            //     ctx.strokeText(bottomLine, canvas.width / 2, canvas.height - 20);
            // }
        }

        Canvas.prototype.calculate = function (e) {
            if (this.text == null) {
                return false;
            }
            // 确定在画布中的点击位置
            var clickX = e.pageX - canvas.offsetLeft;
            var clickY = e.pageY - canvas.offsetTop;

            // 计算点击与文字的距离 待测试 可能仍然存在问题
            var text = this.text;
            // 文本的最小 Y 和 最大 X
            var textMinY = text.y - text.height;
            var textMaxX = text.x + text.width;

            if (clickX > text.x && clickX < textMaxX && clickY > textMinY && clickY < text.y) {
                text.isSelected = true;
                this.isDragging = true;
            } else {
                text.isSelected = false;
            }

            //更新画布
            circleCanvas.drawCanvas();
        }

        Canvas.prototype.resizeCanvas = function (imgWidth, imgHeight) {
            // 800 500 需要定死，否则图片会越传越小
            var ratio = Math.min(800 / imgWidth, 500 / imgHeight);
            console.log(ratio);
            this.canvas.width = imgWidth * ratio;
            this.canvas.height = imgHeight * ratio;
        }

        /* 文字输入 */
        let inputElm = document.getElementById('inputText');
        let inputbtnElm = document.getElementById('inputBtn');
        inputbtnElm.addEventListener('click', function (e) {
            circleCanvas.drawText(e);
        })

        /* 选择文件 */
        function handleFileSelect(evt) {
            var canvasWidth = 500;
            var canvasHeight = 500;
            var file = evt.target.files[0];



            var reader = new FileReader();
            reader.onload = function (fileObject) {
                // 文件内容 这里是 图片的 base64 格式
                var data = fileObject.target.result;

                // 创造一个 img 对象
                var image = new Image();
                image.onload = function () {
                    window.imageSrc = this;

                    // 重置 Canvas 大小
                    circleCanvas.resizeCanvas(image.width, image.height);

                    circleCanvas.redrawMeme(window.imageSrc, null, null);
                }

                // 设置图片为背景图片
                image.src = data;
            };

            // 将文件以 DataURL（即base64）方式读取
            reader.readAsDataURL(file);
        }

        // 绑定鼠标按住事件
        circleCanvas.canvas.addEventListener('mousedown', function (e) {
            circleCanvas.calculate(e);
            // console.log('mousedown');
        });

        circleCanvas.canvas.addEventListener('mouseup', function (e) {
            circleCanvas.stopDragging(e);
            // console.log('mouseup');
        });

        circleCanvas.canvas.addEventListener('mouseout', function (e) {
            circleCanvas.stopDragging(e);
            // console.log('mouseout');
        });

        circleCanvas.canvas.addEventListener('mousemove', function (e) {
            circleCanvas.dragText(e);
            // console.log('mousemove');
        });

        document.getElementById('selectFile').addEventListener('change', handleFileSelect, false);
    </script>
</body>

</html>