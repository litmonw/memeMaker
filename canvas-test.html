<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        canvas {
            cursor: pointer;
            border: 1px solid black;
        }
    </style>
</head>

<body>
    <canvas id="canvas" width="400" height="300">
    </canvas>
    <label for="selectFile">
        <input id="selectFile" name="selectFile" type="file" />
    </label>
    <label for="inputText">
        <input id="inputText" name="inputText" type="text" value="请输入文字" />
    </label>
    <input id="inputBtn" type="button" value="输入" />
    <div>
        <button id="add-btn">添加圆圈</button>
        <button id="clear-btn">清空画布</button>
    </div>
    <script>

        // 这个方法用来储存每个圆圈对象
        var Circle = function (x, y, radius, color) {
            this.x = x;
            this.y = y;
            this.radius = radius;
            this.color = color;
            this.isSelected = false;
        }

        // 储存每个文字对象
        var Text = function (content, font, fillStyle, strokeStyle, lineWidth) {
            this.content = content;
            this.font = font;
            this.fillStyle = fillStyle;
            this.strokeStyle = strokeStyle;
            this.lineWidth = lineWidth;
        }

        var Canvas = function (canvasId) {
            this.canvas = document.getElementById(canvasId);
            this.context = this.canvas.getContext("2d");
            // 保存画布上所有的圆圈
            this.circles = [];
            // 上一个被选中的圆圈
            this.previousSelectedCircle;
            // 圆圈拖拽状态
            this.isDragging = false;
            // 背景图片
            this.image;
            // 保存画布上的文字
            this.text;
        }

        Canvas.prototype.addRandomCircle = function () {
            // 为圆圈计算一个随机大小和位置
            var radius = randomFromTo(10, 60);
            var x = randomFromTo(0, this.canvas.width);
            var y = randomFromTo(0, this.canvas.height);

            // 为圆圈计算一个随机颜色
            var colors = ["green", "blue", "red", "yellow", "magenta", "orange", "brown", "purple", "pink"];
            var color = colors[randomFromTo(0, 8)];

            // 创建一个新圆圈
            var circle = new Circle(x, y, radius, color);

            // 把它保存在数组中
            this.circles.push(circle);

            // 重新绘制画布
            this.drawCircles();
        }

        Canvas.prototype.clearCanvas = function () {
            // 去除所有圆圈
            this.circles = [];

            // 重新绘制画布.
            this.drawCircles();
        }

        Canvas.prototype.drawCircles = function () {
            // 清除画布，准备绘制
            this.context.clearRect(0, 0, canvas.width, canvas.height);

            if (this.image != undefined) {
                this.context.drawImage(this.image, 0, 0, this.canvas.width, this.canvas.height);
            }
            var circles = this.circles;
            // 遍历所有圆圈
            for (var i = 0; i < circles.length; i++) {
                var circle = circles[i];

                // 绘制圆圈
                this.context.globalAlpha = 0.85;
                this.context.beginPath();
                this.context.arc(circle.x, circle.y, circle.radius, 0, Math.PI * 2);
                this.context.fillStyle = circle.color;
                this.context.strokeStyle = "blacxk";

                if (circle.isSelected) {
                    this.context.lineWidth = 5;
                }
                else {
                    this.context.lineWidth = 1;
                }
                this.context.fill();
                this.context.stroke();
            }

            if (this.text != undefined) {
                var text = this.text;
                this.context.font = "36pt Impact"
                this.context.fillStyle = text.fillStyle;
                this.context.fillText(text.content, this.canvas.width / 2, 50);
                this.context.strokeStyle = text.strokeStyle;
                this.context.lineWidth = text.lineWidth;
                this.context.strokeText(text.content, this.canvas.width / 2, 50);
            }
        }

        Canvas.prototype.canvasClick = function (e) {
            var circles = this.circles;
            var previousSelectedCircle = this.previousSelectedCircle;
            // 取得画布上被单击的点 e.pageX 点击距离文档的距离 canvas.offsetLeft 画布距离有定位的父级元素（或 body）的距离
            var clickX = e.pageX - canvas.offsetLeft;
            var clickY = e.pageY - canvas.offsetTop;
            // 查找被单击的圆圈
            for (var i = circles.length - 1; i >= 0; i--) {
                var circle = circles[i];
                //使用勾股定理计算这个点与圆心之间的距离
                var distanceFromCenter = Math.sqrt(Math.pow(circle.x - clickX, 2)
                    + Math.pow(circle.y - clickY, 2))
                // 判断这个点是否在圆圈中
                if (distanceFromCenter <= circle.radius) {
                    // 清除之前选择的圆圈
                    if (previousSelectedCircle != null) this.previousSelectedCircle.isSelected = false;
                    this.previousSelectedCircle = circle;

                    //选择新圆圈
                    circle.isSelected = true;

                    // 使圆圈允许拖拽
                    this.isDragging = true;

                    //更新显示
                    circleCanvas.drawCircles();

                    //停止搜索
                    return;
                }
            }
        }

        // Canvas.prototype.stopDragging = function () {
        //     this.isDragging = false;
        // }

        // Canvas.prototype.dragCircle = function (e) {
        //     var canvas = this.canvas;
        //     // 判断圆圈是否开始拖拽
        //     if (this.isDragging == true) {
        //         // 判断拖拽对象是否存在
        //         if (this.previousSelectedCircle != null) {
        //             // 取得鼠标位置
        //             var x = e.pageX - canvas.offsetLeft;
        //             var y = e.pageY - canvas.offsetTop;

        //             // 将圆圈移动到鼠标位置
        //             this.previousSelectedCircle.x = x;
        //             this.previousSelectedCircle.y = y;
        //             // 更新画布
        //             this.drawCircles();
        //         }
        //     }
        // }

        Canvas.prototype.drawText = function (e) {
            var ctx = this.context;
            // ctx.strokeStyle = '#33cc33';
            // ctx.font = "36pt Impact";
            // ctx.textAlign = "center";
            // ctx.fillStyle = 'white';
            // var text = inputElm.value;
            var text = new Text(inputElm.value, '36pt Impact', 'white', 'black', '3');
            this.text = text;

            // 更新画布
            this.drawCircles();

            // x的位置位于文字左下角的位置
            // ctx.strokeText('王治文', 100, 50);
        }

        //在某个范围内生成随机数
        function randomFromTo(from, to) {
            return Math.floor(Math.random() * (to - from + 1) + from);
        }

        let circleCanvas = new Canvas("canvas");
        // 绑定鼠标点击事件
        // circleCanvas.canvas.addEventListener('mousedown', function (e) {
        //     circleCanvas.canvasClick(e);
        // });
        // //
        // circleCanvas.canvas.addEventListener('mouseup', function (e) {
        //     circleCanvas.stopDragging(e);
        // });

        // circleCanvas.canvas.addEventListener('mouseout', function (e) {
        //     circleCanvas.stopDragging(e);
        // });

        // circleCanvas.canvas.addEventListener('mousemove', function (e) {
        //     circleCanvas.dragCircle(e);
        // });

        let addBtnElm = document.getElementById('add-btn');
        let clearBtnElm = document.getElementById('clear-btn');

        addBtnElm.addEventListener('click', function () {
            circleCanvas.addRandomCircle();
        })
        clearBtnElm.addEventListener('click', function () {
            circleCanvas.clearCanvas();
        })

        /* 绘图 */
        Canvas.prototype.redrawMeme = function (image, topLine, bottomLine) {
            this.image = image;
            var ctx = this.context;
            if (image != null)
                ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

            // 文本属性
            ctx.font = '30pt Impact';
            ctx.textAlign = 'center';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 3;
            ctx.fillStyle = 'white';

            if (topLine != null) {
                ctx.fillText(topLine, canvas.width / 2, 40);
                ctx.strokeText(topLine, canvas.width / 2, 40);
            }

            if (bottomLine != null) {
                ctx.fillText(bottomLine, canvas.width / 2, canvas.height - 20);
                ctx.strokeText(bottomLine, canvas.width / 2, canvas.height - 20);
            }
        }


        /* 文字输入 */
        let inputElm = document.getElementById('inputText');
        let inputbtnElm = document.getElementById('inputBtn');
        inputbtnElm.addEventListener('click', function (e) {
            circleCanvas.drawText(e);
        })

        /* 选择文件 */
        function handleFileSelect(evt) {
            var canvasWidth = 500;
            var canvasHeight = 500;
            var file = evt.target.files[0];



            var reader = new FileReader();
            reader.onload = function (fileObject) {
                // 文件内容 这里是 图片的 base64 格式
                var data = fileObject.target.result;

                // 创造一个 img 对象
                var image = new Image();
                image.onload = function () {
                    window.imageSrc = this;
                    circleCanvas.redrawMeme(window.imageSrc, null, null);
                }

                // 设置图片为背景图片
                image.src = data;
            };

            // 将文件以 DataURL（即base64）方式读取
            reader.readAsDataURL(file);
        }

        document.getElementById('selectFile').addEventListener('change', handleFileSelect, false);
    </script>
</body>

</html>